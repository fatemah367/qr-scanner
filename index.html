<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner</title>

<!-- Manifest (embedded) -->
<link rel="manifest" id="app-manifest">
<script>
document.getElementById("app-manifest").setAttribute(
    "href",
    "data:application/json," + encodeURIComponent(JSON.stringify({
        "name": "QR Scanner",
        "short_name": "QRScan",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#000000",
        "icons": []
    }))
);
</script>

<style>
/* Your exact existing UI CSS here â€” unchanged */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    text-align: center;
    background: #fff;
}
#preview {
    width: 100%;
    max-width: 500px;
    margin-top: 20px;
}
button {
    padding: 10px 20px;
    margin-top: 15px;
    font-size: 16px;
    cursor: pointer;
}
</style>
</head>
<body>

<h1>QR Scanner</h1>
<video id="preview"></video>
<button id="openBtn" style="display:none;">Open Link</button>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
// Start QR Scanner
function startScanner() {
    const html5QrCode = new Html5Qrcode("preview");
    const qrConfig = { fps: 10, qrbox: 250 };
    
    html5QrCode.start(
        { facingMode: "environment" },
        qrConfig,
        qrCodeMessage => {
            handleQRCode(qrCodeMessage);
        }
    ).catch(err => console.error("QR Start Error:", err));
}

function handleQRCode(url) {
    console.log("Scanned:", url);

    // Try automatic open
    try {
        window.location.href = url;
    } catch (e) {
        console.log("Auto open blocked:", e);
        showFallback(url);
    }
}

function showFallback(url) {
    const btn = document.getElementById("openBtn");
    btn.style.display = "inline-block";
    btn.onclick = () => { window.open(url, "_blank"); };
}

// Detect Thunkable WebViewer
function isThunkableWebViewer() {
    return navigator.userAgent.includes("ThunkableWebview");
}

// Adjust behaviour if Thunkable
if (isThunkableWebViewer()) {
    console.log("Running inside Thunkable Web Viewer");
}

startScanner();
</script>

<!-- Offline service worker -->
<script>
const swCode = `
self.addEventListener('install', e => {
    e.waitUntil(caches.open('qr-cache').then(cache => cache.addAll(['./'])));
});
self.addEventListener('fetch', e => {
    e.respondWith(caches.match(e.request).then(resp => resp || fetch(e.request)));
});
`;
const blob = new Blob([swCode], { type: "application/javascript" });
const swUrl = URL.createObjectURL(blob);
navigator.serviceWorker.register(swUrl);
</script>

</body>
</html>
