<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro QR Scanner</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
  width:100%; height:100%;
  font-family:'Poppins',sans-serif;
  background:#121212; color:#fff;
}
video { width:100vw; height:100vh; object-fit:cover; }

/* Result box */
#result {
  position:fixed; bottom:25px; left:50%;
  transform:translateX(-50%);
  padding:14px 20px; border-radius:14px;
  font-size:16px; max-width:90%; text-align:left;
  opacity:0; pointer-events:none;
  box-shadow:0 5px 15px rgba(0,0,0,0.5);
  transition:all 0.3s ease-in-out;
  backdrop-filter:blur(6px);
}
.trusted { background:rgba(76,175,80,0.95); }
.warning { background:rgba(255,193,7,0.95); color:#121212; }
.danger  { background:rgba(244,67,54,0.95); }
.show { opacity:1; transform:translateX(-50%) translateY(0); }

#copyBtn {
  margin-top:8px; padding:6px 10px; border-radius:8px;
  font-size:14px; border:none; cursor:pointer; font-weight:bold;
}

/* Light/Dark toggle */
#modeToggle, #flashBtn {
  position:fixed; top:15px; padding:8px 12px;
  border-radius:12px; font-size:14px; cursor:pointer;
  background:rgba(255,255,255,0.15);
  backdrop-filter:blur(4px);
}
#modeToggle { right:15px; }
#flashBtn { left:15px; }
</style>
</head>

<body>
<video id="video"></video>

<div id="result">
  <span id="statusText">Scanning...</span><br>
  <button id="copyBtn">Copy URL</button>
</div>

<button id="modeToggle">Toggle Light/Dark</button>
<button id="flashBtn">💡</button>

<script type="module">
import QrScanner from "https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js";

const videoElem = document.getElementById('video');
const resultElem = document.getElementById('result');
const statusText = document.getElementById('statusText');
const copyBtn = document.getElementById('copyBtn');
const modeToggle = document.getElementById('modeToggle');
const flashBtn = document.getElementById('flashBtn');

const successSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-951.mp3');
const dangerSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alert-quick-warning-916.mp3');

const trustedDomains = ["example.com", "mytrustedsite.org", "mycompany.net"];
const badDomains = ["phishingsite.com", "malware-test.org"];

let lastScanned = '';
let torchOn = false;

function checkUrlStatus(url) {
  try {
    const parsed = new URL(url);
    if (trustedDomains.some(d => parsed.hostname.endsWith(d))) return "trusted";
    if (badDomains.some(d => parsed.hostname.endsWith(d))) return "danger";
    return "warning";
  } catch {
    return "warning";
  }
}

function showMessage(message, status) {
  if (lastScanned === message) return;
  lastScanned = message;

  resultElem.className = status + " show";
  statusText.innerHTML = message;

  if (navigator.vibrate) navigator.vibrate(status === "danger" ? [200,100,200] : 150);
  if (status === "trusted") successSound.play().catch(()=>{});
  if (status === "danger") dangerSound.play().catch(()=>{});

  setTimeout(() => { resultElem.classList.remove("show"); }, 3000);
}

copyBtn.addEventListener('click', () => {
  if (lastScanned) {
    navigator.clipboard.writeText(lastScanned).then(() => alert("Copied!"));
  }
});

// QR Scanner
const scanner = new QrScanner(videoElem, result => {
  let status = checkUrlStatus(result);
  if (status === "trusted") showMessage(`✅ Trusted QR Code: ${result}`, "trusted");
  else if (status === "danger") showMessage(`⛔ Dangerous QR Code: ${result}`, "danger");
  else showMessage(`⚠️ Unknown QR Code: ${result}`, "warning");

  if (status !== "danger") {
    try { window.open(result, "_blank", "noopener,noreferrer"); } catch (e) {}
  }
}, {
  maxScansPerSecond: 8
});

scanner.start();
QrScanner.hasCamera().then(hasCamera => {
  if (hasCamera) scanner.setCamera("environment");
});

// Light/Dark toggle
modeToggle.addEventListener('click', () => {
  document.body.classList.toggle('light');
  if (document.body.classList.contains('light')) {
    document.body.style.background = '#f0f0f0';
    document.body.style.color = '#121212';
  } else {
    document.body.style.background = '#121212';
    document.body.style.color = '#fff';
  }
});

// Flashlight toggle
flashBtn.addEventListener('click', async () => {
  const track = scanner.$video.srcObject.getVideoTracks()[0];
  if (!track.getCapabilities().torch) {
    alert("Flashlight not supported on this device");
    return;
  }
  torchOn = !torchOn;
  await track.applyConstraints({ advanced: [{ torch: torchOn }] });
});
</script>
</body>
</html>
