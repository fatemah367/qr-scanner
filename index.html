<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<style>
/* Your existing CSS — unchanged */
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background: #f5f5f5;
}
#qr-reader {
  width: 300px;
  margin: auto;
}
.status {
  margin-top: 20px;
  font-size: 18px;
}
.status.trusted { color: green; }
.status.danger { color: red; }
.status.warning { color: orange; }
button {
  margin-top: 10px;
  padding: 8px 15px;
}
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<h1>QR Scanner</h1>
<div id="qr-reader"></div>
<div id="status" class="status"></div>
<button id="openBtn" style="display:none;">Open Link</button>

<script>
let lastScanned = null;
let openTimer = null;

function showMessage(message, type) {
    const statusText = document.getElementById("status");
    statusText.className = "status " + type;
    statusText.innerHTML = `${message}<br><button id="copyBtn">Copy URL</button>`;
    document.getElementById("copyBtn").onclick = function() {
        navigator.clipboard.writeText(lastScanned || "").then(() => {
            alert("URL copied to clipboard!");
        });
    };
}

function scanSuccess(result) {
    if (!result || result === lastScanned) return;
    lastScanned = result;

    // Check status of QR code
    let status;
    if (result.includes("trusted.com")) status = "trusted";
    else if (result.includes("dangerous.com")) status = "danger";
    else status = "warning";

    if (status === "trusted") showMessage(`✅ Trusted QR Code<br>${result}`, "trusted");
    else if (status === "danger") showMessage(`⛔ Dangerous QR Code<br>${result}`, "danger");
    else showMessage(`⚠️ Unknown QR Code<br>${result}`, "warning");

    const openBtn = document.getElementById("openBtn");
    openBtn.style.display = status !== "danger" ? "inline-block" : "none";
    openBtn.onclick = function() { window.open(result, "_blank", "noopener,noreferrer"); };

    // Auto-open only once per scan
    if (status !== "danger") {
        // Detect if inside Thunkable Web Viewer
        const isThunkable = /thunkable/i.test(navigator.userAgent);
        clearTimeout(openTimer);
        openTimer = setTimeout(() => {
            window.open(result, "_blank", "noopener,noreferrer");
        }, isThunkable ? 200 : 0);
    }
}

// Start QR scanner
const html5QrCode = new Html5Qrcode("qr-reader");
html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    scanSuccess
).catch(err => {
    console.error("Camera start error", err);
});
</script>
</body>
</html>
