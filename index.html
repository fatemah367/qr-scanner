<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QR Code Scanner</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
    background-color: #f8f8f8;
  }
  video {
    width: 100%;
    max-width: 500px;
    margin-top: 20px;
    border: 2px solid #ccc;
    border-radius: 10px;
  }
  #result {
    margin-top: 15px;
    font-size: 1.1em;
    word-break: break-all;
  }
  #openBtn {
    display: none;
    margin-top: 10px;
    padding: 10px 20px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #openBtn:hover {
    background-color: #0056b3;
  }
</style>
</head>
<body>
<h2>QR Code Scanner</h2>
<video id="preview"></video>
<div id="result"></div>
<button id="openBtn">Open Link</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const resultDiv = document.getElementById("result");
  const openBtn = document.getElementById("openBtn");

  function isThunkableWebview() {
    return navigator.userAgent.includes("ThunkableWebViewer");
  }

  function openInNewTab(url) {
    window.open(url, "_blank");
  }

  function handleScanSuccess(decodedText) {
    resultDiv.textContent = decodedText;
    openBtn.style.display = "inline-block";
    openBtn.onclick = () => openInNewTab(decodedText);

    if (/^https?:\/\//i.test(decodedText)) {
      if (isThunkableWebview()) {
        // Delay so Thunkable allows it
        setTimeout(() => openInNewTab(decodedText), 200);
      } else {
        openInNewTab(decodedText);
      }
    }
  }

  function handleScanError(error) {
    // We ignore scan errors to keep scanning
  }

  const html5QrCode = new Html5Qrcode("preview");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    handleScanSuccess,
    handleScanError
  );

  // Silent offline mode via service worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      const swCode = `
        self.addEventListener('install', e => { self.skipWaiting(); });
        self.addEventListener('fetch', e => { e.respondWith(fetch(e.request).catch(() => caches.match(e.request))); });
      `;
      const blob = new Blob([swCode], { type: "application/javascript" });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl);
    });
  }
</script>
</body>
</html>
